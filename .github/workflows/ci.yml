---
name: CI

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format-19
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19
          sudo apt-get install -y clang-format-19

      - name: Check formatting
        run: |
          find src include tests -name '*.cpp' -o -name '*.hpp' | \
            xargs clang-format-19 --dry-run --Werror

  build:
    name: Build (${{ matrix.compiler }}, ${{ matrix.build_type }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-13, clang-19]
        build_type: [Debug, Release]
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM 19
        if: matrix.compiler == 'clang-19'
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libelf-dev zlib1g-dev
          if [ "${{ matrix.compiler }}" = "gcc-13" ]; then
            sudo apt-get install -y g++-13
          fi

      - name: Build libbpf 1.3.0 from source
        run: |
          git clone https://github.com/libbpf/libbpf.git \
            --depth 1 --branch v1.3.0
          cd libbpf/src
          make
          sudo make install
          sudo ldconfig
          echo "/usr/lib64" | sudo tee /etc/ld.so.conf.d/lib64.conf
          sudo ldconfig

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git --depth 1
          ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: |
          if [ "${{ matrix.compiler }}" = "gcc-13" ]; then
            export CC=gcc-13 CXX=g++-13
          else
            export CC=clang-19 CXX=clang++-19
          fi
          TOOLCHAIN=$PWD/vcpkg/scripts/buildsystems/vcpkg.cmake
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN \
            -DTHREVEAL_ENABLE_TESTING=ON \
            -DTHREVEAL_ENABLE_BPF=ON \
            -DTHREVEAL_ENABLE_SANITIZERS=OFF

      - name: Build
        run: cmake --build build --parallel

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: threveal-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: |
            build/libthreveal_core.a
            build/libthreveal_bpf.a
            build/test_topology
            build/test_events
            build/test_event_store
            build/test_errors
            build/test_pmu_counter
            build/test_pmu_group
            build/test_pmu_sampler
            build/test_ebpf_loader
            build/test_migration_tracker
          retention-days: 7

  test:
    name: Test (${{ matrix.compiler }})
    needs: build
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc-13, clang-19]
    steps:
      - uses: actions/checkout@v4

      - name: Install runtime dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libelf-dev zlib1g-dev
          git clone https://github.com/libbpf/libbpf.git \
            --depth 1 --branch v1.3.0
          cd libbpf/src
          make
          sudo make install
          echo "/usr/lib64" | sudo tee /etc/ld.so.conf.d/lib64.conf
          sudo ldconfig

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: threveal-${{ matrix.compiler }}-Debug
          path: build

      - name: Make test executables runnable
        run: |
          chmod +x build/test_topology
          chmod +x build/test_events
          chmod +x build/test_event_store
          chmod +x build/test_errors
          chmod +x build/test_pmu_counter
          chmod +x build/test_pmu_group
          chmod +x build/test_pmu_sampler
          chmod +x build/test_ebpf_loader
          chmod +x build/test_migration_tracker

      - name: Run unit tests
        run: |
          ./build/test_topology
          ./build/test_events
          ./build/test_event_store
          ./build/test_errors
          ./build/test_pmu_counter
          ./build/test_pmu_group
          ./build/test_pmu_sampler
          ./build/test_ebpf_loader
          ./build/test_migration_tracker

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM 19
        run: |
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 19
          sudo apt-get install -y clang-tidy-19

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libelf-dev zlib1g-dev

      - name: Build libbpf 1.3.0 from source
        run: |
          git clone https://github.com/libbpf/libbpf.git \
            --depth 1 --branch v1.3.0
          cd libbpf/src
          make
          sudo make install
          echo "/usr/lib64" | sudo tee /etc/ld.so.conf.d/lib64.conf
          sudo ldconfig

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git --depth 1
          ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: |
          TOOLCHAIN=$PWD/vcpkg/scripts/buildsystems/vcpkg.cmake
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=clang++-19 \
            -DCMAKE_TOOLCHAIN_FILE=$TOOLCHAIN \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DTHREVEAL_ENABLE_BPF=ON

      - name: Build
        run: cmake --build build --parallel

      - name: Run clang-tidy
        run: |
          find src -name '*.cpp' | \
            xargs clang-tidy-19 -p build --warnings-as-errors='*'
